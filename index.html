<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ·é¾Ÿæ±¤ - æ¨ç†è§£è°œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --steam-dark: #171a21;
            --steam-blue: #1b2838;
            --steam-light: #66c0f4;
            --steam-highlight: #c7d5e0;
        }

        body {
            background: var(--steam-blue);
            color: var(--steam-highlight);
            font-family: 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
            margin: 0;
            background-image: linear-gradient(45deg, rgba(0,0,0,0.3) 25%, transparent 25%), 
                            linear-gradient(-45deg, rgba(0,0,0,0.3) 25%, transparent 25%);
            background-size: 4px 4px;
        }

        /* æ·»åŠ åŠ¨æ€èƒŒæ™¯ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(125deg, #1b2838 0%, #171a21 100%),
                url('data:image/svg+xml,%3Csvg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z" fill="%2366c0f4" fill-opacity="0.1" fill-rule="evenodd"/%3E%3C/svg%3E');
            animation: backgroundAnimation 30s linear infinite;
            z-index: -1;
        }

        @keyframes backgroundAnimation {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: 100% 100%;
            }
        }

        .game-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background: rgba(23, 26, 33, 0.95);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(102, 192, 244, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(102, 192, 244, 0.3);
            border: 1px solid rgba(102, 192, 244, 0.2);
        }

        .scenario-box {
            background: rgba(27, 40, 56, 0.9);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--steam-light);
            position: relative;
            overflow: hidden;
            background: linear-gradient(
                135deg,
                rgba(27, 40, 56, 0.95),
                rgba(27, 40, 56, 0.8)
            );
        }

        .scenario-box::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 65%, rgba(102, 192, 244, 0.1));
            pointer-events: none;
        }

        .scenario-box::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, 
                var(--steam-light), 
                transparent, 
                var(--steam-light));
            z-index: -1;
            border-radius: 12px;
            animation: borderGlow 3s linear infinite;
        }

        @keyframes borderGlow {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: 200% 200%;
            }
        }

        .question-box {
            background: rgba(27, 40, 56, 0.8);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(102, 192, 244, 0.3);
        }

        .answer-box {
            background: rgba(27, 40, 56, 0.8);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(102, 192, 244, 0.3);
        }

        .hint-box {
            background: rgba(27, 40, 56, 0.8);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 77, 79, 0.3);
        }

        .game-title {
            color: var(--steam-light);
            text-align: center;
            margin-bottom: 2rem;
            font-weight: bold;
            text-shadow: 
                0 0 5px rgba(102, 192, 244, 0.5),
                0 0 10px rgba(102, 192, 244, 0.3),
                0 0 15px rgba(102, 192, 244, 0.2);
            font-size: 2.5rem;
            animation: glowingText 2s ease-in-out infinite alternate;
        }

        @keyframes glowingText {
            from {
                text-shadow: 
                    0 0 5px rgba(102, 192, 244, 0.5),
                    0 0 10px rgba(102, 192, 244, 0.3),
                    0 0 15px rgba(102, 192, 244, 0.2);
            }
            to {
                text-shadow: 
                    0 0 10px rgba(102, 192, 244, 0.7),
                    0 0 20px rgba(102, 192, 244, 0.5),
                    0 0 30px rgba(102, 192, 244, 0.3);
            }
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(27, 40, 56, 0.8);
            border-radius: 8px;
            border: 1px solid var(--steam-light);
        }

        .stat-item {
            text-align: center;
            position: relative;
        }

        .stat-item h5 {
            color: var(--steam-light);
            margin-bottom: 0.5rem;
        }

        .stat-item span {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--steam-highlight);
        }

        .btn-custom {
            background: linear-gradient(to bottom, var(--steam-light), #4b89b5);
            border: none;
            color: var(--steam-dark);
            font-weight: bold;
            padding: 0.8rem 1.5rem;
            margin: 0.5rem;
            transition: all 0.3s;
            text-shadow: 0 1px 1px rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(102, 192, 244, 0.5);
            background: linear-gradient(to bottom, #7dcbff, var(--steam-light));
        }

        .btn-custom:disabled {
            background: #4a5d75;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-custom::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(102, 192, 244, 0.1),
                transparent
            );
            transform: rotate(45deg);
            animation: buttonGlow 3s linear infinite;
        }

        @keyframes buttonGlow {
            0% {
                transform: rotate(45deg) translateX(-100%);
            }
            100% {
                transform: rotate(45deg) translateX(100%);
            }
        }

        .history-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(27, 40, 56, 0.8);
            border-radius: 8px;
            border: 1px solid var(--steam-light);
            scrollbar-width: thin;
            scrollbar-color: var(--steam-light) var(--steam-blue);
        }

        .history-container::-webkit-scrollbar {
            width: 8px;
            background: rgba(27, 40, 56, 0.5);
        }

        .history-container::-webkit-scrollbar-track {
            background: var(--steam-blue);
        }

        .history-container::-webkit-scrollbar-thumb {
            background: linear-gradient(
                to bottom,
                var(--steam-light),
                rgba(102, 192, 244, 0.5)
            );
            border-radius: 4px;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(23, 26, 33, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--steam-blue);
            border-top: 5px solid var(--steam-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 20px rgba(102, 192, 244, 0.3);
        }

        .input-group {
            background: rgba(27, 40, 56, 0.95);
            padding: 0.5rem;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid var(--steam-light);
        }

        .input-group:focus-within {
            box-shadow: 0 0 20px rgba(102, 192, 244, 0.3);
            transform: translateY(-2px);
        }

        .form-control {
            background: rgba(199, 213, 224, 0.1);
            border: 1px solid var(--steam-light);
            color: var(--steam-highlight);
        }

        .form-control:focus {
            background: rgba(199, 213, 224, 0.2);
            border-color: var(--steam-light);
            color: var(--steam-highlight);
            box-shadow: 0 0 10px rgba(102, 192, 244, 0.3);
        }

        .achievement {
            position: fixed;
            bottom: 20px;
            right: -300px;
            background: rgba(27, 40, 56, 0.95);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: right 0.5s ease-in-out;
            z-index: 1000;
        }

        .achievement.show {
            right: 20px;
        }

        .achievement-icon {
            width: 50px;
            height: 50px;
            background: var(--steam-light);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .game-info {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--steam-highlight);
            font-style: italic;
        }

        .achievement-list {
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(27, 40, 56, 0.8);
            border-radius: 8px;
            border: 1px solid var(--steam-light);
        }

        .achievement-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            border-bottom: 1px solid rgba(102, 192, 244, 0.2);
            background: rgba(27, 40, 56, 0.8);
            border-radius: 10px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .achievement-item:last-child {
            border-bottom: none;
        }

        .achievement-item:hover {
            transform: translateX(5px);
            box-shadow: 
                -5px 0 15px rgba(102, 192, 244, 0.2),
                0 0 10px rgba(102, 192, 244, 0.1);
            border-color: rgba(102, 192, 244, 0.4);
        }

        /* ä¿®æ”¹æ¨¡å¼é€‰æ‹©çš„æ ·å¼ */
        .mode-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            gap: 2rem;
        }

        .mode-cards {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin-top: 2rem;
        }

        .mode-card {
            background: rgba(27, 40, 56, 0.9);
            padding: 3rem;
            border-radius: 15px;
            border: 1px solid var(--steam-light);
            width: 300px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.5s ease, box-shadow 0.5s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            transform-style: preserve-3d;
        }

        .mode-card:hover {
            transform: 
                translateY(-10px) 
                rotateX(5deg) 
                rotateY(5deg);
            box-shadow: 
                0 15px 35px rgba(102, 192, 244, 0.2),
                0 0 15px rgba(102, 192, 244, 0.3);
        }

        .mode-icon {
            font-size: 4rem;
            color: var(--steam-light);
            margin-bottom: 1rem;
        }

        .mode-card h4 {
            font-size: 1.5rem;
            color: var(--steam-light);
            margin-bottom: 0.5rem;
        }

        .mode-card p {
            color: var(--steam-highlight);
            font-size: 1rem;
            opacity: 0.8;
        }

        /* æ·»åŠ åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mode-card {
            animation: fadeIn 0.5s ease-out;
        }

        .mode-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .room-info {
            background: rgba(27, 40, 56, 0.9);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1rem 0;
        }

        .player-card {
            background: rgba(102, 192, 244, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            border: 1px solid var(--steam-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .current-player {
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .turn-indicator {
            color: #4CAF50;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        #modeSelection {
            text-align: center;
        }

        #singlePlayerMode, #multiPlayerMode {
            display: none;
        }

        .room-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .copy-button {
            background: none;
            border: none;
            color: var(--steam-light);
            cursor: pointer;
            padding: 0;
            margin-left: 0.5rem;
        }

        .copy-button:hover {
            color: var(--steam-highlight);
        }

        #questionRemaining {
            font-size: 0.8rem;
            margin-left: 5px;
            opacity: 0.8;
        }

        .answer-reveal {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4CAF50;
        }

        .category-selection {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(27, 40, 56, 0.8);
            border-radius: 8px;
            border: 1px solid var(--steam-light);
        }

        .category-group {
            flex: 1;
        }

        .category-group h4 {
            color: var(--steam-light);
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .form-select {
            background: rgba(199, 213, 224, 0.1);
            border: 1px solid var(--steam-light);
            color: var(--steam-highlight);
            width: 100%;
        }

        .form-select:focus {
            background: rgba(199, 213, 224, 0.2);
            border-color: var(--steam-light);
            color: var(--steam-highlight);
            box-shadow: 0 0 10px rgba(102, 192, 244, 0.3);
        }

        .answer-input-box {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(27, 40, 56, 0.8);
            border-radius: 8px;
            border: 1px solid var(--steam-light);
        }

        .answer-input-box small {
            display: block;
            margin-top: 0.5rem;
            color: var(--steam-highlight);
        }

        .correct-answer {
            background: rgba(76, 175, 80, 0.1);
            border-color: #4CAF50;
        }

        .wrong-answer {
            background: rgba(244, 67, 54, 0.1);
            border-color: #F44336;
        }

        .back-to-lobby {
            margin-bottom: 1rem;
            text-align: left;
        }

        .back-to-lobby .btn-custom {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            background: rgba(27, 40, 56, 0.9);
            border: 1px solid var(--steam-light);
        }

        .back-to-lobby .btn-custom:hover {
            background: rgba(102, 192, 244, 0.2);
            transform: translateY(-2px);
        }

        /* åœ¨å¤šäººæ¨¡å¼ç•Œé¢æ·»åŠ è¿”å›æŒ‰é’® */
        .back-to-lobby {
            margin-bottom: 1rem;
            text-align: left;
        }

        .back-to-lobby .btn-custom {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            background: rgba(27, 40, 56, 0.9);
            border: 1px solid var(--steam-light);
        }

        .back-to-lobby .btn-custom:hover {
            background: rgba(102, 192, 244, 0.2);
            transform: translateY(-2px);
        }

        /* æˆ¿é—´çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .room-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(27, 40, 56, 0.8);
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid var(--steam-light);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator i {
            font-size: 0.8rem;
        }

        .status-indicator i.waiting {
            color: #ffc107;
            animation: blink 1s infinite;
        }

        .status-indicator i.playing {
            color: #4CAF50;
        }

        @keyframes blink {
            50% { opacity: 0.5; }
        }

        .player-card {
            position: relative;
            background: rgba(27, 40, 56, 0.9);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--steam-light);
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(102, 192, 244, 0.2);
        }

        .player-card.current-player {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .host-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--steam-light);
            color: var(--steam-dark);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .turn-indicator {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .room-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .player-stats {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .player-stats i {
            color: var(--steam-light);
        }

        .chat-box {
            background: rgba(27, 40, 56, 0.8);
            border-radius: 8px;
            border: 1px solid var(--steam-light);
            margin-top: 1rem;
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .chat-input {
            padding: 1rem;
            border-top: 1px solid var(--steam-light);
        }

        .game-timer {
            text-align: center;
            font-size: 1.2rem;
            margin: 1rem 0;
            color: var(--steam-light);
        }

        /* åœ¨æˆ¿ä¸»æ§åˆ¶åŒºåŸŸæ·»åŠ  */
        .host-controls {
            display: none;
        }

        /* æ·»åŠ è¯­éŸ³èŠå¤©åŒºåŸŸ */
        .voice-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        #voiceStatus {
            background: rgba(27, 40, 56, 0.9);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--steam-light);
            color: var(--steam-light);
            animation: pulse 1.5s infinite;
        }

        #voiceStatus i {
            margin-right: 8px;
            color: #ff4444;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        #startGameBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #playerCountHint {
            margin-top: 5px;
            color: var(--steam-light);
        }

        .turn-indicator-message {
            background: rgba(27, 40, 56, 0.9);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            color: var(--steam-light);
            border: 1px solid var(--steam-light);
        }

        .turn-indicator-message.my-turn {
            background: rgba(76, 175, 80, 0.1);
            border-color: #4CAF50;
            color: #4CAF50;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        #question:disabled, #askQuestion:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* åœ¨ roomInfo div ä¸­æ·»åŠ  */
        .chat-area {
            margin-top: 1rem;
            background: rgba(27, 40, 56, 0.9);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
            padding: 1rem;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid var(--steam-light);
        }

        .input-group {
            background: rgba(27, 40, 56, 0.95);
            padding: 0.5rem;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid var(--steam-light);
        }

        .input-group:focus-within {
            box-shadow: 0 0 20px rgba(102, 192, 244, 0.3);
            transform: translateY(-2px);
        }

        .form-control {
            background: rgba(199, 213, 224, 0.1);
            border: 1px solid var(--steam-light);
            color: var(--steam-highlight);
        }

        .form-control:focus {
            background: rgba(199, 213, 224, 0.2);
            border-color: var(--steam-light);
            color: var(--steam-highlight);
            box-shadow: 0 0 10px rgba(102, 192, 244, 0.3);
        }

        .btn-custom {
            background: linear-gradient(to bottom, var(--steam-light), #4b89b5);
            border: none;
            color: var(--steam-dark);
            font-weight: bold;
            padding: 0.8rem 1.5rem;
            margin: 0.5rem;
            transition: all 0.3s;
            text-shadow: 0 1px 1px rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(102, 192, 244, 0.5);
            background: linear-gradient(to bottom, #7dcbff, var(--steam-light));
        }

        .btn-custom:disabled {
            background: #4a5d75;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-custom::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(102, 192, 244, 0.1),
                transparent
            );
            transform: rotate(45deg);
            animation: buttonGlow 3s linear infinite;
        }

        @keyframes buttonGlow {
            0% {
                transform: rotate(45deg) translateX(-100%);
            }
            100% {
                transform: rotate(45deg) translateX(100%);
            }
        }

        /* åœ¨ style æ ‡ç­¾ä¸­æ·»åŠ  */
        .chat-area {
            margin-top: 1rem;
            background: rgba(27, 40, 56, 0.9);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid var(--steam-light);
        }

        .chat-message {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            max-width: 80%;
            word-break: break-word;
        }

        .chat-message.self {
            background: rgba(102, 192, 244, 0.1);
            border: 1px solid var(--steam-light);
            align-self: flex-end;
        }

        .chat-message.other {
            background: rgba(27, 40, 56, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            align-self: flex-start;
        }

        .chat-message .sender {
            font-size: 0.8rem;
            color: var(--steam-light);
            margin-bottom: 0.2rem;
        }

        .chat-message .time {
            font-size: 0.7rem;
            color: rgba(199, 213, 224, 0.5);
            margin-top: 0.2rem;
            text-align: right;
        }

        .room-list-area {
            margin-top: 2rem;
            background: rgba(27, 40, 56, 0.9);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
            padding: 1rem;
        }

        .room-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .room-item {
            background: rgba(27, 40, 56, 0.8);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-info {
            flex-grow: 1;
        }

        .room-categories {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--steam-light);
        }

        .category {
            background: rgba(102, 192, 244, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .join-btn {
            background: linear-gradient(to bottom, var(--steam-light), #4b89b5);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            color: var(--steam-dark);
            cursor: pointer;
            transition: all 0.3s;
        }

        .join-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(102, 192, 244, 0.5);
        }

        .join-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* æ·»åŠ æˆ¿ä¸»æ§åˆ¶é¢æ¿æ ·å¼ */
        .host-controls {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(27, 40, 56, 0.9);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
        }

        .join-requests {
            margin-top: 1rem;
        }

        .request-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid rgba(102, 192, 244, 0.2);
        }

        .request-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .admin-controls {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .player-card:hover .admin-controls {
            opacity: 1;
        }

        .admin-controls .btn {
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
        }

        .muted-badge {
            color: #ff4444;
            margin-left: 0.5rem;
            font-size: 0.8rem;
        }

        .player-card {
            position: relative;
            padding-right: 4rem;
        }

        .steam-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .steam-dialog-content {
            background: linear-gradient(to bottom, #2a475e, #1b2838);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
            padding: 1.5rem;
            min-width: 300px;
            max-width: 500px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .steam-dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--steam-light);
        }

        .dialog-title {
            color: var(--steam-light);
            margin: 0;
            font-size: 1.2rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--steam-light);
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #fff;
        }

        .dialog-body {
            color: var(--steam-highlight);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .dialog-buttons .btn {
            min-width: 80px;
        }

        /* åœ¨å¤šäººæ¨¡å¼çš„åˆ†ç±»é€‰æ‹©æ ·å¼ */
        .category-selection {
            background: rgba(27, 40, 56, 0.9);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .category-group {
            margin-bottom: 1rem;
        }

        .category-group h4 {
            color: var(--steam-light);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .category-group select {
            width: 100%;
            background: rgba(27, 40, 56, 0.8);
            border: 1px solid var(--steam-light);
            color: var(--steam-highlight);
            padding: 0.5rem;
            border-radius: 4px;
        }

        .category-group select:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(102, 192, 244, 0.3);
        }

        .category-group select option {
            background: var(--steam-blue);
            color: var(--steam-highlight);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">ğŸ¢ æµ·é¾Ÿæ±¤ - æ¨ç†è§£è°œ ğŸœ</h1>
        <div class="game-info">ä¸€æ¬¾å……æ»¡æ™ºæ…§ä¸è¶£å‘³çš„æ¨ç†è§£è°œæ¸¸æˆ</div>

        <!-- æ¨¡å¼é€‰æ‹©ç•Œé¢ -->
        <div class="mode-selection" id="modeSelection">
            <div class="mode-cards">
                <div class="mode-card" onclick="selectMode('single')">
                    <div class="mode-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <h4>å•äººæ¨¡å¼</h4>
                    <p>ç‹¬è‡ªä½“éªŒæ¨ç†è§£è°œçš„ä¹è¶£</p>
                </div>
                <div class="mode-card" onclick="selectMode('multi')">
                    <div class="mode-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h4>å¤šäººæ¨¡å¼</h4>
                    <p>ä¸å¥½å‹ä¸€èµ·ç ´è§£è°œé¢˜</p>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆå†…å®¹åŒºåŸŸ -->
        <div id="gameContent" style="display: none;">
            <div class="back-to-lobby">
                <button class="btn btn-custom" onclick="backToLobby()">
                    <i class="fas fa-arrow-left"></i> è¿”å›å¤§å…
                </button>
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <h5><i class="fas fa-question-circle"></i> å·²é—®é—®é¢˜</h5>
                    <span id="questionCount">0</span>
                </div>
                <div class="stat-item">
                    <h5><i class="fas fa-lightbulb"></i> å‰©ä½™æç¤º</h5>
                    <span id="hintCount">2</span>
                </div>
                <div class="stat-item">
                    <h5><i class="fas fa-trophy"></i> æˆå°±ç‚¹æ•°</h5>
                    <span id="achievementPoints">0</span>
                </div>
            </div>

            <div id="scenarioBox" class="scenario-box" style="display: none;">
                <h4><i class="fas fa-theater-masks"></i> å½“å‰åœºæ™¯</h4>
                <p id="scenario"></p>
            </div>

            <div id="categorySelection" class="category-selection" style="display: none;">
                <div class="category-group">
                    <h4>æ•…äº‹ç±»å‹</h4>
                    <select id="storyType" class="form-select">
                        <option value="">-- è¯·é€‰æ‹© --</option>
                    </select>
                </div>
                <div class="category-group">
                    <h4>éš¾åº¦ç­‰çº§</h4>
                    <select id="difficulty" class="form-select">
                        <option value="">-- è¯·é€‰æ‹© --</option>
                    </select>
                </div>
                <div class="category-group">
                    <h4>æ•…äº‹ä¸»é¢˜</h4>
                    <select id="theme" class="form-select">
                        <option value="">-- è¯·é€‰æ‹© --</option>
                    </select>
                </div>
            </div>

            <div class="mb-3">
                <button id="startGame" class="btn btn-custom btn-lg w-100" style="display: none;">
                    <i class="fas fa-play"></i> å¼€å§‹æ–°æ¸¸æˆ
                </button>
            </div>

            <div id="gameControls" style="display: none;">
                <div class="mb-3">
                    <label for="question" class="form-label">
                        <i class="fas fa-question"></i> æé—®ï¼ˆåªèƒ½é—®æ˜¯/å¦é—®é¢˜ï¼‰ï¼š
                    </label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="question" placeholder="è¾“å…¥ä½ çš„é—®é¢˜...">
                        <button class="btn btn-custom" id="askQuestion">
                            <i class="fas fa-paper-plane"></i> æé—®
                        </button>
                    </div>
                </div>

                <button id="requestHint" class="btn btn-custom">
                    <i class="fas fa-lightbulb"></i> è·å–æç¤º
                </button>
                
                <!-- æ–°å¢ç­”æ¡ˆæŒ‰é’®ï¼Œé»˜è®¤ç¦ç”¨ -->
                <button id="showAnswer" class="btn btn-custom" disabled>
                    <i class="fas fa-key"></i> æŸ¥çœ‹ç­”æ¡ˆ
                    <small id="questionRemaining"></small>
                </button>
            </div>

            <div class="history-container mt-4">
                <h4><i class="fas fa-history"></i> æ¸¸æˆè®°å½•</h4>
                <div id="history"></div>
            </div>

            <div class="achievement-list">
                <h4><i class="fas fa-trophy"></i> æˆå°±åˆ—è¡¨</h4>
                <div class="achievement-item">
                    <div class="achievement-icon">ğŸ¯</div>
                    <div>
                        <h5>åˆæ¬¡ç ´æ¡ˆ</h5>
                        <p>æˆåŠŸè§£å¼€ç¬¬ä¸€ä¸ªè°œé¢˜</p>
                    </div>
                </div>
                <div class="achievement-item">
                    <div class="achievement-icon">ğŸ”</div>
                    <div>
                        <h5>æ•é”æ´å¯Ÿ</h5>
                        <p>ç”¨ä¸è¶…è¿‡5ä¸ªé—®é¢˜è§£å¼€è°œé¢˜</p>
                    </div>
                </div>
            </div>

            <!-- åœ¨æ¸¸æˆæ§åˆ¶åŒºåŸŸæ·»åŠ ç­”æ¡ˆè¾“å…¥æ¡† -->
            <div id="answerInput" class="answer-input-box">
                <div class="input-group">
                    <input type="text" id="userAnswer" class="form-control" placeholder="è¾“å…¥ä½ çš„ç­”æ¡ˆ...">
                    <button class="btn btn-custom" id="submitAnswer">
                        <i class="fas fa-paper-plane"></i> æäº¤ç­”æ¡ˆ
                    </button>
                </div>
                <small id="answerAttempts" class="text-muted"></small>
            </div>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <div id="achievement" class="achievement">
        <div class="achievement-icon">ğŸ†</div>
        <div>
            <h5>è§£é”æ–°æˆå°±ï¼</h5>
            <p id="achievementText"></p>
        </div>
    </div>

    <!-- å•äººæ¨¡å¼ç•Œé¢ -->
    <div id="singlePlayerMode">
        <!-- ... (åŸæœ‰çš„å•äººæ¨¡å¼å†…å®¹) ... -->
    </div>

    <!-- å¤šäººæ¨¡å¼ç•Œé¢ -->
    <div id="multiPlayerMode">
        <div class="back-to-lobby">
            <button class="btn btn-custom" onclick="backToLobby()">
                <i class="fas fa-arrow-left"></i> è¿”å›å¤§å…
            </button>
        </div>

        <!-- æˆ¿é—´çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="room-status">
            <div class="status-indicator">
                <i class="fas fa-circle"></i> 
                <span id="roomStatus">ç­‰å¾…ä¸­</span>
            </div>
            <div class="player-count">
                <i class="fas fa-users"></i> 
                <span id="playerCount">1/8</span>
            </div>
        </div>
        
        <!-- åˆ›å»º/åŠ å…¥æˆ¿é—´ -->
        <div id="roomJoinCreate">
            <div class="mb-3">
                <button class="btn btn-custom btn-lg w-100" onclick="showCreateRoom()">
                    <i class="fas fa-plus"></i> åˆ›å»ºæˆ¿é—´
                </button>
            </div>
            
            <!-- æ·»åŠ ç©å®¶åç§°è¾“å…¥å’Œæˆ¿é—´åˆ—è¡¨ -->
            <div class="room-list-area">
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="playerNameInput" placeholder="è¯·è¾“å…¥ä½ çš„åå­—...">
                    </div>
                </div>
                <h4><i class="fas fa-list"></i> å¯ç”¨æˆ¿é—´</h4>
                <div id="roomList" class="room-list">
                    <!-- æˆ¿é—´åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>

        <!-- æˆ¿é—´ä¿¡æ¯ -->
        <div id="roomInfo" style="display: none;">
            <div class="room-info">
                <h4>æˆ¿é—´ä¿¡æ¯</h4>
                <p>æˆ¿é—´ID: <span id="roomId"></span> 
                    <button class="copy-button" onclick="copyRoomId()">
                        <i class="fas fa-copy"></i>
                    </button>
                </p>
                <div class="player-list" id="playerList"></div>
            </div>

            <!-- æ·»åŠ èŠå¤©åŒºåŸŸ -->
            <div class="chat-area">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-area">
                    <div class="input-group">
                        <input type="text" class="form-control" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯...">
                        <button class="btn btn-custom" onclick="sendChatMessage()">
                            <i class="fas fa-paper-plane"></i> å‘é€
                        </button>
                    </div>
                </div>
            </div>

            <div id="hostControls" style="display: none;">
                <div class="join-requests">
                    <h5><i class="fas fa-user-plus"></i> åŠ å…¥è¯·æ±‚</h5>
                    <div id="joinRequestsList">
                        <!-- åŠ å…¥è¯·æ±‚å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
                <button id="startGameBtn" class="btn btn-custom" onclick="startMultiGame()" disabled>
                    <i class="fas fa-play"></i> å¼€å§‹æ¸¸æˆ
                </button>
                <div id="playerCountHint" class="text-muted small">
                    éœ€è¦2-8åç©å®¶æ‰èƒ½å¼€å§‹æ¸¸æˆ
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆç•Œé¢ -->
        <div id="gameInterface" style="display: none;">
            <!-- ... (ä¸å•äººæ¨¡å¼ç±»ä¼¼çš„æ¸¸æˆç•Œé¢) ... -->
        </div>
    </div>

    <!-- æ·»åŠ è¯­éŸ³èŠå¤©åŒºåŸŸ -->
    <div class="voice-chat">
        <div id="voiceStatus" class="d-none">
            <i class="fas fa-microphone"></i> æ­£åœ¨è¯´è¯...
        </div>
    </div>

    <!-- æ·»åŠ  Steam é£æ ¼çš„å¼¹æ¡† HTML -->
    <div id="steamDialog" class="steam-dialog" style="display: none;">
        <div class="steam-dialog-content">
            <div class="steam-dialog-header">
                <h4 class="dialog-title"></h4>
                <button class="close-btn" onclick="closeSteamDialog()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="dialog-body"></div>
            <div class="dialog-buttons"></div>
        </div>
    </div>

    <script>
        // åœ¨ apiKey å˜é‡å®šä¹‰ä¹‹å‰æ·»åŠ 
        const STORY_CATEGORIES = {
            type: {
                'horror': 'ææ€–æƒŠæ‚š',
                'mystery': 'æ‚¬ç–‘æ¨ç†',
                'emotion': 'æƒ…æ„Ÿæ•…äº‹',
                'fantasy': 'å¥‡å¹»å†’é™©',
                'logic': 'é€»è¾‘æ¨ç†',
                'career': 'èŒä¸šæ•…äº‹'
            },
            difficulty: {
                'easy': 'ç®€å•å…¥é—¨',
                'medium': 'ä¸­ç­‰éš¾åº¦',
                'hard': 'é«˜éš¾åº¦æŒ‘æˆ˜'
            },
            theme: {
                'daily': 'æ—¥å¸¸ç”Ÿæ´»',
                'history': 'å†å²æ–‡åŒ–',
                'scifi': 'ç§‘å¹»æœªæ¥',
                'fairy': 'ç«¥è¯ç¥è¯'
            }
        };

        let apiKey = '';
        let currentRoom = null;
        let isHost = false;
        let playerName = '';
        let currentPlayer = '';
        let gameInterval = null;
        const API_BASE_URL = 'http://localhost:8000';  // æœ¬åœ°æµ‹è¯•ç”¨
        let gameMode = 'single'; // é»˜è®¤ä¸ºå•äººæ¨¡å¼

        // æ·»åŠ å…¨å±€å˜é‡
        let isVoiceActive = false;
        let mediaRecorder = null;
        let audioChunks = [];

        // ä¿®æ”¹ API è·¯å¾„å¸¸é‡
        const API = {
            single: {
                startGame: `${API_BASE_URL}/single/start_game`,
                askQuestion: `${API_BASE_URL}/single/ask_question`,
                requestHint: `${API_BASE_URL}/single/request_hint`,
                getAnswer: `${API_BASE_URL}/single/get_answer`,
                checkAnswer: `${API_BASE_URL}/single/check_answer`
            },
            multi: {
                createRoom: `${API_BASE_URL}/multi/create_room`,
                joinRoom: `${API_BASE_URL}/multi/join_room`,
                startGame: `${API_BASE_URL}/multi/start_game`,
                askQuestion: `${API_BASE_URL}/multi/ask_question`,
                requestHint: `${API_BASE_URL}/multi/request_hint`,
                getRoomStatus: `${API_BASE_URL}/multi/get_room_status`,
                checkAnswer: `${API_BASE_URL}/multi/check_answer`,
                sendVoice: `${API_BASE_URL}/multi/send_voice`,
                sendMessage: `${API_BASE_URL}/multi/send_message`,
                kickPlayer: `${API_BASE_URL}/multi/kick_player`,
                mutePlayer: `${API_BASE_URL}/multi/mute_player`
            }
        };

        async function getApiKey() {
            showLoading();
            let retries = 3;
            while (retries > 0) {
                try {
                    const response = await fetch(`${API_BASE_URL}/generate_key`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    apiKey = data.api_key;
                    hideLoading();
                    return;
                } catch (error) {
                    console.error('è·å–APIå¯†é’¥å¤±è´¥ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°:', retries - 1);
                    retries--;
                    if (retries === 0) {
                        throw new Error('æ— æ³•è·å–APIå¯†é’¥');
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’åé‡è¯•
                }
            }
            hideLoading();
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function addToHistory(content, type) {
            const history = document.getElementById('history');
            const entry = document.createElement('div');
            entry.className = `${type}-box fade-in`;
            entry.innerHTML = content;
            history.insertBefore(entry, history.firstChild);
        }

        function selectMode(mode) {
            gameMode = mode;
            document.getElementById('modeSelection').style.display = 'none';
            
            if (mode === 'single') {
                document.getElementById('gameContent').style.display = 'block';
                document.getElementById('multiPlayerMode').style.display = 'none';
                // æ˜¾ç¤ºåˆ†ç±»é€‰æ‹©
                document.getElementById('categorySelection').style.display = 'block';
                // æ˜¾ç¤ºå¼€å§‹æ¸¸æˆæŒ‰é’®
                document.getElementById('startGame').style.display = 'block';
            } else {
                document.getElementById('gameContent').style.display = 'none';
                document.getElementById('multiPlayerMode').style.display = 'block';
                document.getElementById('roomJoinCreate').style.display = 'block';
                document.getElementById('roomInfo').style.display = 'none';
                getRoomList();  // ç«‹å³è·å–æˆ¿é—´åˆ—è¡¨
            }
        }

        // ä¿®æ”¹åˆ›å»ºæˆ¿é—´çš„å¯¹è¯æ¡†å‡½æ•°
        async function showCreateRoom() {
            // è·å–åˆ†ç±»é€‰é¡¹çš„HTML
            const categorySelectionHTML = `
                <div class="category-selection">
                    <div class="category-group">
                        <h4>æ•…äº‹ç±»å‹</h4>
                        <select id="createRoomStoryType" class="form-select">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                            ${Object.entries(STORY_CATEGORIES.type).map(([key, value]) => 
                                `<option value="${key}">${value}</option>`).join('')}
                        </select>
                    </div>
                    <div class="category-group">
                        <h4>éš¾åº¦ç­‰çº§</h4>
                        <select id="createRoomDifficulty" class="form-select">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                            ${Object.entries(STORY_CATEGORIES.difficulty).map(([key, value]) => 
                                `<option value="${key}">${value}</option>`).join('')}
                        </select>
                    </div>
                    <div class="category-group">
                        <h4>æ•…äº‹ä¸»é¢˜</h4>
                        <select id="createRoomTheme" class="form-select">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                            ${Object.entries(STORY_CATEGORIES.theme).map(([key, value]) => 
                                `<option value="${key}">${value}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <input type="text" class="form-control" id="createRoomPlayerName" placeholder="è¾“å…¥ä½ çš„åå­—...">
                </div>
            `;

            showSteamDialog('åˆ›å»ºæˆ¿é—´', 'é€‰æ‹©æ¸¸æˆç±»å‹å¹¶è¾“å…¥ä½ çš„åå­—:', [
                {
                    text: 'åˆ›å»º',
                    class: 'btn-primary',
                    onClick: async () => {
                        const name = document.getElementById('createRoomPlayerName').value.trim();
                        const storyType = document.getElementById('createRoomStoryType').value;
                        const difficulty = document.getElementById('createRoomDifficulty').value;
                        const theme = document.getElementById('createRoomTheme').value;
                        
                        if (!name) {
                            showSteamDialog('é”™è¯¯', 'è¯·è¾“å…¥æœ‰æ•ˆçš„åå­—', [{
                                text: 'ç¡®å®š',
                                class: 'btn-danger',
                                onClick: () => showCreateRoom()
                            }]);
                            return;
                        }
                        
                        await createRoom(name, storyType, difficulty, theme);
                    }
                },
                {
                    text: 'å–æ¶ˆ',
                    class: 'btn-secondary',
                    onClick: () => {}
                }
            ], categorySelectionHTML);
        }

        // ä¿®æ”¹ createRoom å‡½æ•°ï¼Œåœ¨åˆ›å»ºæˆ¿é—´æˆåŠŸååˆå§‹åŒ–æˆ¿ä¸»æ§åˆ¶
        async function createRoom(name, storyType, difficulty, theme) {
            showLoading();
            try {
                if (!apiKey) {
                    await getApiKey();
                }

                const response = await fetch(API.multi.createRoom, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        host_name: name,
                        story_type: storyType,
                        difficulty: difficulty,
                        theme: theme
                    })
                });

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    currentRoom = data.room_id;
                    isHost = true;
                    playerName = name;
                    
                    // æ›´æ–°ç•Œé¢
                    document.getElementById('roomJoinCreate').style.display = 'none';
                    document.getElementById('roomInfo').style.display = 'block';
                    document.getElementById('hostControls').style.display = 'block';
                    document.getElementById('roomId').textContent = data.room_id;
                    
                    // åˆå§‹åŒ–æˆ¿ä¸»æ§åˆ¶
                    updateHostControls();
                    
                    // å¼€å§‹è½®è¯¢æˆ¿é—´çŠ¶æ€
                    startPollingRoomStatus();
                    
                    showSteamDialog('æˆåŠŸ', 'æˆ¿é—´åˆ›å»ºæˆåŠŸï¼', [{
                        text: 'ç¡®å®š',
                        class: 'btn-primary',
                        onClick: () => {}
                    }]);
                } else {
                    throw new Error(data.message || 'åˆ›å»ºæˆ¿é—´å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ›å»ºæˆ¿é—´å¤±è´¥:', error);
                showSteamDialog('é”™è¯¯', `åˆ›å»ºæˆ¿é—´å¤±è´¥: ${error.message}`, [{
                    text: 'é‡è¯•',
                    class: 'btn-primary',
                    onClick: () => showCreateRoom()
                }]);
            } finally {
                hideLoading();
            }
        }

        async function joinRoom() {
            const roomId = document.getElementById('joinRoomId').value.trim();
            const name = document.getElementById('joinPlayerName').value.trim();
            
            if (!roomId || !name) {
                alert('è¯·è¾“å…¥æˆ¿é—´IDå’Œç©å®¶åç§°');
                return;
            }

            showLoading();
            try {
                // ç¡®ä¿å…ˆè·å– API key
                if (!apiKey) {
                    await getApiKey();
                }

                console.log('Joining room:', { roomId, name });
                
                const response = await fetch(API.multi.joinRoom, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: roomId,
                        player_name: name
                    })
                });

                console.log('Join room response status:', response.status);
                const data = await response.json();
                console.log('Join room response:', data);

                if (response.ok && data.status === 'success') {
                    currentRoom = roomId;
                    playerName = name;
                    isHost = false;
                    
                    // æ›´æ–°ç•Œé¢
                    document.getElementById('roomJoinCreate').style.display = 'none';
                    document.getElementById('roomInfo').style.display = 'block';
                    document.getElementById('roomId').textContent = roomId;
                    
                    // å¼€å§‹è½®è¯¢æˆ¿é—´çŠ¶æ€
                    startPollingRoomStatus();
                    updatePlayerList(data.players);
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    alert('æˆåŠŸåŠ å…¥æˆ¿é—´ï¼');
                } else {
                    throw new Error(data.message || data.error || 'åŠ å…¥æˆ¿é—´å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ å…¥æˆ¿é—´å¤±è´¥:', error);
                alert(`åŠ å…¥æˆ¿é—´å¤±è´¥: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // æ·»åŠ ç©å®¶ç®¡ç†èœå•
        function updatePlayerList(players = []) {
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';
            
            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${player.name === currentPlayer ? 'current-player' : ''}`;
                
                // æ·»åŠ æˆ¿ä¸»ç®¡ç†èœå•
                const adminControls = isHost && player.name !== playerName ? `
                    <div class="admin-controls">
                        <button class="btn btn-sm btn-custom" onclick="kickPlayer('${player.name}')">
                            <i class="fas fa-user-times"></i>
                        </button>
                        <button class="btn btn-sm btn-custom" onclick="mutePlayer('${player.name}')">
                            <i class="fas fa-microphone-slash"></i>
                        </button>
                    </div>
                ` : '';
                
                const muteStatus = player.muted_until && player.muted_until > Date.now() / 1000 ? 
                    '<span class="muted-badge"><i class="fas fa-microphone-slash"></i></span>' : '';
                
                playerCard.innerHTML = `
                    ${player.is_host ? '<span class="host-badge">æˆ¿ä¸»</span>' : ''}
                    ${player.name === currentPlayer ? '<span class="turn-indicator">å½“å‰å›åˆ</span>' : ''}
                    <h5>${player.name} ${muteStatus}</h5>
                    <div class="player-stats">
                        <i class="fas fa-star"></i> ${player.score} åˆ†
                        <i class="fas fa-question-circle"></i> ${player.questions || 0} é—®é¢˜
                    </div>
                    ${adminControls}
                `;
                
                playerList.appendChild(playerCard);
            });
        }

        // æ·»åŠ è¸¢äººåŠŸèƒ½
        async function kickPlayer(playerName) {
            if (!confirm(`ç¡®å®šè¦å°† ${playerName} è¸¢å‡ºæˆ¿é—´å—ï¼Ÿ`)) return;
            
            try {
                const response = await fetch(API.multi.kickPlayer, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom,
                        host_name: playerName,
                        player_name: playerName
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    alert(data.message);
                } else {
                    throw new Error(data.message || 'æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                console.error('è¸¢å‡ºç©å®¶å¤±è´¥:', error);
                alert(error.message || 'è¸¢å‡ºç©å®¶å¤±è´¥');
            }
        }

        // æ·»åŠ ç¦è¨€åŠŸèƒ½
        async function mutePlayer(playerName) {
            const duration = prompt('è¯·è¾“å…¥ç¦è¨€æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰:', '5');
            if (!duration) return;
            
            try {
                const response = await fetch(API.multi.mutePlayer, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom,
                        host_name: playerName,
                        player_name: playerName,
                        duration: parseInt(duration) * 60
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    alert(data.message);
                } else {
                    throw new Error(data.message || 'æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                console.error('ç¦è¨€ç©å®¶å¤±è´¥:', error);
                alert(error.message || 'ç¦è¨€ç©å®¶å¤±è´¥');
            }
        }

        function startPollingRoomStatus() {
            if (gameInterval) {
                clearInterval(gameInterval);
            }
            gameInterval = setInterval(pollRoomStatus, 3000);
            pollRoomStatus(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        }

        async function pollRoomStatus() {
            if (!currentRoom) return;
            
            try {
                const response = await fetch(API.multi.getRoomStatus, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    updateRoomStatus(data.room_status);
                    updatePlayerCount(data.players.length);
                    updatePlayerList(data.players);
                    
                    // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œæ›´æ–°åŠ å…¥è¯·æ±‚åˆ—è¡¨
                    if (isHost && data.join_requests) {
                        updateJoinRequests(data.join_requests);
                    }
                    
                    // æ›´æ–°å¼€å§‹æ¸¸æˆæŒ‰é’®çŠ¶æ€ï¼ˆä»…æˆ¿ä¸»å¯è§ï¼‰
                    if (isHost) {
                        const startGameBtn = document.getElementById('startGameBtn');
                        if (startGameBtn) {
                            const playerCount = data.players.length;
                            // ä¿®æ”¹è¿™é‡Œï¼šå½“ç©å®¶æ•°é‡åœ¨2-8äººä¹‹é—´ä¸”æ¸¸æˆæœªå¼€å§‹æ—¶ï¼Œå¯ç”¨å¼€å§‹æŒ‰é’®
                            startGameBtn.disabled = playerCount < 2 || playerCount > 8 || data.room_status === 'playing';
                            document.getElementById('playerCountHint').textContent = 
                                data.room_status === 'playing' ? 'æ¸¸æˆè¿›è¡Œä¸­' :
                                playerCount < 2 ? 'è‡³å°‘éœ€è¦2åç©å®¶' :
                                playerCount > 8 ? 'æœ€å¤šå…è®¸8åç©å®¶' :
                                'å¯ä»¥å¼€å§‹æ¸¸æˆ';
                        }
                    }
                    
                    // å¦‚æœæ¸¸æˆå·²ç»å¼€å§‹ï¼Œç¡®ä¿æ‰€æœ‰ç©å®¶éƒ½èƒ½çœ‹åˆ°æ¸¸æˆç•Œé¢
                    if (data.room_status === 'playing' && data.current_scenario) {
                        if (document.getElementById('gameContent').style.display === 'none') {
                            showGameInterface({
                                scenario: data.current_scenario,
                                hint_count: data.hint_count
                            });
                        }
                        
                        // æ›´æ–°åœºæ™¯æ–‡æœ¬
                        document.getElementById('scenario').textContent = data.current_scenario;
                        
                        // æ›´æ–°å½“å‰ç©å®¶çŠ¶æ€
                        updateCurrentPlayer(data.current_player);
                    }
                    
                    // æ›´æ–°èŠå¤©æ¶ˆæ¯
                    updateChatMessages(data.chat_messages);
                }
            } catch (error) {
                console.error('è·å–æˆ¿é—´çŠ¶æ€å¤±è´¥:', error);
            }
        }

        function copyRoomId() {
            const roomId = document.getElementById('roomId').textContent;
            navigator.clipboard.writeText(roomId);
            alert('æˆ¿é—´IDå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }

        async function startGame() {
            showLoading();
            try {
                // ç¡®ä¿ API key å­˜åœ¨
                if (!apiKey) {
                    await getApiKey();
                }

                const url = gameMode === 'single' ? API.single.startGame : API.multi.startGame;
                const storyType = document.getElementById('storyType').value;
                const difficulty = document.getElementById('difficulty').value;
                const theme = document.getElementById('theme').value;
                
                console.log('Starting game with:', { gameMode, storyType, difficulty, theme }); // è°ƒè¯•æ—¥å¿—

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom,
                        player_name: playerName,
                        story_type: storyType,
                        difficulty: difficulty,
                        theme: theme
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Game start response:', data); // è°ƒè¯•æ—¥å¿—
                
                if (data.status === 'success') {
                    document.getElementById('scenario').textContent = data.scenario;
                    document.getElementById('scenarioBox').style.display = 'block';
                    document.getElementById('gameControls').style.display = 'block';
                    document.getElementById('startGame').textContent = 'é‡æ–°å¼€å§‹';
                    document.getElementById('hintCount').textContent = data.hint_count;
                    document.getElementById('questionCount').textContent = '0';
                    document.getElementById('history').innerHTML = '';
                    addToHistory(`<strong>æ–°æ¸¸æˆå¼€å§‹ï¼</strong><br>åœºæ™¯ï¼š${data.scenario}`, 'scenario');
                    
                    // é‡ç½®ç­”æ¡ˆç›¸å…³çŠ¶æ€
                    const showAnswerBtn = document.getElementById('showAnswer');
                    showAnswerBtn.disabled = true;
                    document.getElementById('questionRemaining').textContent = '(è¿˜éœ€20ä¸ªé—®é¢˜)';
                    if (data.answer_attempts) {
                        document.getElementById('answerAttempts').textContent = 
                            `å‰©ä½™å°è¯•æ¬¡æ•°ï¼š${data.answer_attempts}`;
                    }
                } else {
                    throw new Error(data.message || 'å¼€å§‹æ¸¸æˆå¤±è´¥');
                }
            } catch (error) {
                console.error('å¼€å§‹æ¸¸æˆå¤±è´¥:', error);
                alert('å¼€å§‹æ¸¸æˆå¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function askQuestion() {
            const questionInput = document.getElementById('question');
            const question = questionInput.value.trim();
            
            if (!question) {
                alert('è¯·è¾“å…¥é—®é¢˜');
                return;
            }

            showLoading();
            try {
                const url = gameMode === 'single' ? API.single.askQuestion : API.multi.askQuestion;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        question: question,
                        room_id: currentRoom,
                        player_name: playerName
                    })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateQuestionCount(data.question_count);
                    addToHistory(`<strong>Q: ${question}</strong><br>A: ${data.answer}`, 'question');
                } else {
                    alert(data.message || 'æé—®å¤±è´¥');
                }
                questionInput.value = '';
            } catch (error) {
                console.error('æé—®å¤±è´¥:', error);
                alert('æé—®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
            hideLoading();
        }

        async function requestHint() {
            showLoading();
            try {
                const url = gameMode === 'single' ? API.single.requestHint : API.multi.requestHint;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom,
                        player_name: playerName
                    })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('hintCount').textContent = data.remaining_hints;
                    addToHistory(`<strong>æç¤ºï¼š</strong><br>${data.hint}`, 'hint');
                } else {
                    alert(data.message || 'è·å–æç¤ºå¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–æç¤ºå¤±è´¥:', error);
                alert('è·å–æç¤ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
            hideLoading();
        }

        // æ·»åŠ æˆå°±ç³»ç»Ÿ
        function showAchievement(title) {
            const achievement = document.getElementById('achievement');
            document.getElementById('achievementText').textContent = title;
            achievement.classList.add('show');
            
            setTimeout(() => {
                achievement.classList.remove('show');
            }, 3000);
            
            // æ›´æ–°æˆå°±ç‚¹æ•°
            const points = document.getElementById('achievementPoints');
            points.textContent = parseInt(points.textContent) + 10;
        }

        // æ›´æ–°é—®é¢˜è®¡æ•°å’Œç­”æ¡ˆæŒ‰é’®çŠ¶æ€çš„å‡½æ•°
        function updateQuestionCount(count) {
            const questionCount = document.getElementById('questionCount');
            const showAnswerBtn = document.getElementById('showAnswer');
            const questionRemaining = document.getElementById('questionRemaining');
            
            questionCount.textContent = count;
            
            if (gameMode === 'single') {
                const remainingQuestions = 20 - count;
                if (remainingQuestions > 0) {
                    showAnswerBtn.disabled = true;
                    questionRemaining.textContent = `(è¿˜éœ€${remainingQuestions}ä¸ªé—®é¢˜)`;
                } else {
                    showAnswerBtn.disabled = false;
                    questionRemaining.textContent = '(å¯æŸ¥çœ‹ç­”æ¡ˆ)';
                }
            }
        }

        // è·å–ç­”æ¡ˆçš„å‡½æ•°
        async function showAnswer() {
            showLoading();
            try {
                const response = await fetch(API.single.getAnswer, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey
                    })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    addToHistory(`<strong>æœ€ç»ˆç­”æ¡ˆï¼š</strong><br>${data.answer}`, 'answer-reveal');
                } else {
                    alert(data.message || 'è·å–ç­”æ¡ˆå¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–ç­”æ¡ˆå¤±è´¥:', error);
                alert('è·å–ç­”æ¡ˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
            hideLoading();
        }

        // åœ¨åˆå§‹åŒ–æ—¶åŠ è½½åˆ†ç±»æ•°æ®
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/get_categories`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const categories = await response.json();
                console.log('Loaded categories:', categories); // è°ƒè¯•æ—¥å¿—
                
                const storyTypeSelect = document.getElementById('storyType');
                const difficultySelect = document.getElementById('difficulty');
                const themeSelect = document.getElementById('theme');
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                storyTypeSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                difficultySelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                themeSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                
                // å¡«å……é€‰é¡¹
                if (categories.type) {
                    Object.entries(categories.type).forEach(([key, value]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = value;
                        storyTypeSelect.appendChild(option);
                    });
                }
                
                if (categories.difficulty) {
                    Object.entries(categories.difficulty).forEach(([key, value]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = value;
                        difficultySelect.appendChild(option);
                    });
                }
                
                if (categories.theme) {
                    Object.entries(categories.theme).forEach(([key, value]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = value;
                        themeSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
                alert('åŠ è½½åˆ†ç±»å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // æ·»åŠ æäº¤ç­”æ¡ˆçš„å‡½æ•°
        async function submitAnswer() {
            const answerInput = document.getElementById('userAnswer');
            const answer = answerInput.value.trim();
            
            if (!answer) {
                alert('è¯·è¾“å…¥ç­”æ¡ˆ');
                return;
            }

            showLoading();
            try {
                const url = gameMode === 'single' ? API.single.checkAnswer : API.multi.checkAnswer;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        answer: answer,
                        room_id: currentRoom,
                        player_name: playerName
                    })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    const className = data.is_correct ? 'correct-answer' : 'wrong-answer';
                    addToHistory(`<strong>ä½ çš„ç­”æ¡ˆï¼š</strong><br>${answer}<br><strong>ç»“æœï¼š</strong>${data.message}`, className);
                    document.getElementById('answerAttempts').textContent = 
                        `å‰©ä½™å°è¯•æ¬¡æ•°ï¼š${data.remaining_attempts}`;
                    
                    if (data.is_correct) {
                        showAchievement('è§£è°œæˆåŠŸï¼');
                        setTimeout(() => {
                            if (confirm('æ­å–œä½ ç­”å¯¹äº†ï¼è¦å¼€å§‹æ–°çš„æ¸¸æˆå—ï¼Ÿ')) {
                                startGame();
                            }
                        }, 1500);
                    }
                    
                    answerInput.value = '';
                } else {
                    alert(data.message || 'æäº¤ç­”æ¡ˆå¤±è´¥');
                }
            } catch (error) {
                console.error('æäº¤ç­”æ¡ˆå¤±è´¥:', error);
                alert('æäº¤ç­”æ¡ˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
            hideLoading();
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await getApiKey();
                console.log('API key obtained:', apiKey ? 'Yes' : 'No');
                
                if (!apiKey) {
                    throw new Error('æ— æ³•è·å–APIå¯†é’¥');
                }
                
                await loadCategories();
                
                document.getElementById('startGame').addEventListener('click', startGame);
                document.getElementById('askQuestion').addEventListener('click', askQuestion);
                document.getElementById('requestHint').addEventListener('click', requestHint);
                document.getElementById('showAnswer').addEventListener('click', showAnswer);
                document.getElementById('submitAnswer').addEventListener('click', submitAnswer);
                
                document.getElementById('question').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        askQuestion();
                    }
                });

                document.getElementById('userAnswer').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        submitAnswer();
                    }
                });
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                alert('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        });

        function backToLobby() {
            if (confirm('ç¡®å®šè¦è¿”å›å¤§å…å—ï¼Ÿå½“å‰æ¸¸æˆè¿›åº¦å°†ä¸ä¼šä¿å­˜ã€‚')) {
                // æ¸…é™¤è®¡æ—¶å™¨
                if (gameTimer) {
                    clearInterval(gameTimer);
                    gameTimer = null;
                }
                
                // æ¸…é™¤è½®è¯¢
                if (gameInterval) {
                    clearInterval(gameInterval);
                    gameInterval = null;
                }
                
                // é‡ç½®çŠ¶æ€
                document.getElementById('gameContent').style.display = 'none';
                document.getElementById('multiPlayerMode').style.display = 'none';
                document.getElementById('modeSelection').style.display = 'flex';
                document.getElementById('history').innerHTML = '';
                document.getElementById('scenarioBox').style.display = 'none';
                document.getElementById('gameControls').style.display = 'none';
                
                // é‡ç½®è®¡æ•°å™¨
                document.getElementById('questionCount').textContent = '0';
                document.getElementById('hintCount').textContent = '2';
                
                // æ¸…ç©ºè¾“å…¥
                document.getElementById('question').value = '';
                document.getElementById('userAnswer').value = '';
                document.getElementById('joinRoomId').value = '';
                document.getElementById('joinPlayerName').value = '';
                
                // é‡ç½®å˜é‡
                currentRoom = null;
                isHost = false;
                playerName = '';
                currentPlayer = '';
            }
        }

        // æ·»åŠ å¤šäººæ¨¡å¼çš„åŠŸèƒ½
        function updateRoomStatus(status) {
            const statusIcon = document.querySelector('.status-indicator i');
            const statusText = document.getElementById('roomStatus');
            
            if (status === 'waiting') {
                statusIcon.className = 'fas fa-circle waiting';
                statusText.textContent = 'ç­‰å¾…ç©å®¶åŠ å…¥...';
            } else if (status === 'playing') {
                statusIcon.className = 'fas fa-circle playing';
                statusText.textContent = 'æ¸¸æˆè¿›è¡Œä¸­';
            }
        }

        function updatePlayerCount(current, max = 8) {
            document.getElementById('playerCount').textContent = `${current}/${max}`;
        }

        // æ·»åŠ æ¸¸æˆè®¡æ—¶å™¨
        let gameTimer;
        function startGameTimer() {
            let seconds = 0;
            const timerElement = document.createElement('div');
            timerElement.className = 'game-timer';
            document.querySelector('.room-info').appendChild(timerElement);
            
            gameTimer = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                timerElement.textContent = `æ¸¸æˆæ—¶é—´: ${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // ä¿®æ”¹ startMultiGame å‡½æ•°ï¼Œæ·»åŠ é”™è¯¯æ£€æŸ¥
        async function startMultiGame() {
            try {
                if (!currentRoom || !playerName) {
                    throw new Error('æˆ¿é—´ä¿¡æ¯ä¸å®Œæ•´');
                }

                // è·å–æ¸¸æˆç±»å‹é€‰æ‹©
                const storyTypeSelect = document.getElementById('multiStoryType');
                const difficultySelect = document.getElementById('multiDifficulty');
                const themeSelect = document.getElementById('multiTheme');

                if (!storyTypeSelect || !difficultySelect || !themeSelect) {
                    throw new Error('æ¸¸æˆè®¾ç½®æ§ä»¶æœªæ­£ç¡®åˆå§‹åŒ–');
                }

                const storyType = storyTypeSelect.value;
                const difficulty = difficultySelect.value;
                const theme = themeSelect.value;

                if (!storyType || !difficulty || !theme) {
                    throw new Error('è¯·é€‰æ‹©æ¸¸æˆç±»å‹ã€éš¾åº¦å’Œä¸»é¢˜');
                }

                console.log('Starting multiplayer game:', { currentRoom, playerName, storyType, difficulty, theme });

                const response = await fetch(API.multi.startGame, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom,
                        player_name: playerName,
                        story_type: storyType,
                        difficulty: difficulty,
                        theme: theme
                    })
                });

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    // æ›´æ–°æ¸¸æˆçŠ¶æ€
                    document.getElementById('startGameBtn').disabled = true;
                    updateRoomStatus('playing');
                    
                    // æ˜¾ç¤ºæ¸¸æˆå†…å®¹ç»™æ‰€æœ‰ç©å®¶
                    showGameInterface(data);

                    // æ ¹æ®ç©å®¶æ•°é‡è®¾ç½®æ‰€éœ€é—®é¢˜æ•°
                    const requiredQuestions = data.player_count === 2 ? 15 : 20;
                    const questionRemainingElement = document.getElementById('questionRemaining');
                    if (questionRemainingElement) {
                        questionRemainingElement.textContent = `(è¿˜éœ€${requiredQuestions}ä¸ªé—®é¢˜)`;
                    }
                    
                    // ä¿å­˜æ‰€éœ€é—®é¢˜æ•°åˆ°å…¨å±€å˜é‡
                    window.requiredQuestions = requiredQuestions;
                } else {
                    throw new Error(data.message || data.error || 'å¼€å§‹æ¸¸æˆå¤±è´¥');
                }
            } catch (error) {
                console.error('å¼€å§‹æ¸¸æˆå¤±è´¥:', error);
                showSteamDialog('é”™è¯¯', `å¼€å§‹æ¸¸æˆå¤±è´¥: ${error.message}`, [{
                    text: 'ç¡®å®š',
                    class: 'btn-danger',
                    onClick: () => {}
                }]);
            }
        }

        // ä¿®æ”¹ updateQuestionCount å‡½æ•°
        function updateQuestionCount(count) {
            const questionCount = document.getElementById('questionCount');
            const showAnswerBtn = document.getElementById('showAnswer');
            const questionRemaining = document.getElementById('questionRemaining');
            
            questionCount.textContent = count;
            
            // è·å–å½“å‰æ‰€éœ€é—®é¢˜æ•°ï¼ˆé»˜è®¤20ï¼Œä¸¤äººæ—¶ä¸º15ï¼‰
            const requiredQuestions = window.requiredQuestions || 20;
            
            const remainingQuestions = requiredQuestions - count;
            if (remainingQuestions > 0) {
                showAnswerBtn.disabled = true;
                questionRemaining.textContent = `(è¿˜éœ€${remainingQuestions}ä¸ªé—®é¢˜)`;
            } else {
                showAnswerBtn.disabled = false;
                questionRemaining.textContent = '(å¯æŸ¥çœ‹ç­”æ¡ˆ)';
            }
        }

        // åœ¨æˆ¿ä¸»æ§åˆ¶åŒºåŸŸæ·»åŠ æ¸¸æˆç±»å‹é€‰æ‹©
        function updateHostControls() {
            const hostControls = document.getElementById('hostControls');
            if (!hostControls || hostControls.querySelector('.category-selection')) return;

            // æ·»åŠ æ¸¸æˆç±»å‹é€‰æ‹©ç•Œé¢
            const categorySelection = `
                <div class="category-selection">
                    <div class="category-group">
                        <h4>æ•…äº‹ç±»å‹</h4>
                        <select id="multiStoryType" class="form-select">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                            ${Object.entries(STORY_CATEGORIES.type).map(([key, value]) => 
                                `<option value="${key}">${value}</option>`).join('')}
                        </select>
                    </div>
                    <div class="category-group">
                        <h4>éš¾åº¦ç­‰çº§</h4>
                        <select id="multiDifficulty" class="form-select">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                            ${Object.entries(STORY_CATEGORIES.difficulty).map(([key, value]) => 
                                `<option value="${key}">${value}</option>`).join('')}
                        </select>
                    </div>
                    <div class="category-group">
                        <h4>æ•…äº‹ä¸»é¢˜</h4>
                        <select id="multiTheme" class="form-select">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                            ${Object.entries(STORY_CATEGORIES.theme).map(([key, value]) => 
                                `<option value="${key}">${value}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;

            // åœ¨å¼€å§‹æ¸¸æˆæŒ‰é’®å‰æ’å…¥ç±»å‹é€‰æ‹©
            const startGameBtn = hostControls.querySelector('#startGameBtn');
            if (startGameBtn) {
                const categoryDiv = document.createElement('div');
                categoryDiv.innerHTML = categorySelection;
                hostControls.insertBefore(categoryDiv, startGameBtn);

                // æ·»åŠ é€‰æ‹©éªŒè¯
                const validateGameSettings = () => {
                    const storyType = document.getElementById('multiStoryType')?.value;
                    const difficulty = document.getElementById('multiDifficulty')?.value;
                    const theme = document.getElementById('multiTheme')?.value;
                    const playerCount = document.querySelectorAll('.player-card').length;

                    const startGameBtn = document.getElementById('startGameBtn');
                    if (startGameBtn) {
                        startGameBtn.disabled = !storyType || !difficulty || !theme || playerCount < 2 || playerCount > 8;
                    }

                    const hint = document.getElementById('playerCountHint');
                    if (hint) {
                        if (!storyType || !difficulty || !theme) {
                            hint.textContent = 'è¯·é€‰æ‹©æ¸¸æˆç±»å‹ã€éš¾åº¦å’Œä¸»é¢˜';
                        } else if (playerCount < 2) {
                            hint.textContent = 'è‡³å°‘éœ€è¦2åç©å®¶';
                        } else if (playerCount > 8) {
                            hint.textContent = 'æœ€å¤šå…è®¸8åç©å®¶';
                        } else {
                            hint.textContent = 'å¯ä»¥å¼€å§‹æ¸¸æˆ';
                        }
                    }
                };

                // æ·»åŠ é€‰æ‹©äº‹ä»¶ç›‘å¬
                document.getElementById('multiStoryType')?.addEventListener('change', validateGameSettings);
                document.getElementById('multiDifficulty')?.addEventListener('change', validateGameSettings);
                document.getElementById('multiTheme')?.addEventListener('change', validateGameSettings);
            }
        }

        // ä¿®æ”¹ showGameInterface å‡½æ•°
        function showGameInterface(data) {
            // ... ç°æœ‰ä»£ç  ...

            // æ·»åŠ ç©å®¶æ•°é‡å’Œæ‰€éœ€é—®é¢˜æ•°çš„æ˜¾ç¤º
            const playerCount = data.player_count || 2;
            const requiredQuestions = playerCount === 2 ? 15 : 20;
            window.requiredQuestions = requiredQuestions;

            // æ›´æ–°é—®é¢˜è®¡æ•°æ˜¾ç¤º
            document.getElementById('questionRemaining').textContent = `(è¿˜éœ€${requiredQuestions}ä¸ªé—®é¢˜)`;
            
            // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œæ˜¾ç¤ºå½“å‰æ¸¸æˆè®¾ç½®
            if (isHost) {
                const gameSettings = document.createElement('div');
                gameSettings.className = 'game-settings';
                gameSettings.innerHTML = `
                    <div class="mt-3 mb-3">
                        <h5>å½“å‰æ¸¸æˆè®¾ç½®</h5>
                        <p>
                            ç±»å‹: ${STORY_CATEGORIES.type[data.story_type] || 'æœªè®¾ç½®'}<br>
                            éš¾åº¦: ${STORY_CATEGORIES.difficulty[data.difficulty] || 'æœªè®¾ç½®'}<br>
                            ä¸»é¢˜: ${STORY_CATEGORIES.theme[data.theme] || 'æœªè®¾ç½®'}<br>
                            æ‰€éœ€é—®é¢˜æ•°: ${requiredQuestions}
                        </p>
                    </div>
                `;
                document.getElementById('scenarioBox').appendChild(gameSettings);
            }
        }

        // åœ¨æˆ¿é—´åˆ›å»ºæ—¶åˆå§‹åŒ–æˆ¿ä¸»æ§åˆ¶
        function initializeHostControls() {
            if (isHost) {
                updateHostControls();
            }
        }

        // æ·»åŠ æ˜¾ç¤ºæ¸¸æˆç•Œé¢çš„å‡½æ•°
        function showGameInterface(data) {
            // éšè—æˆ¿é—´åˆ›å»º/åŠ å…¥ç•Œé¢
            document.getElementById('roomJoinCreate').style.display = 'none';
            
            // æ˜¾ç¤ºæ¸¸æˆå†…å®¹
            document.getElementById('gameContent').style.display = 'block';
            document.getElementById('scenarioBox').style.display = 'block';
            document.getElementById('scenario').textContent = data.scenario;
            document.getElementById('gameControls').style.display = 'block';
            
            // é‡ç½®æ¸¸æˆè®¡æ•°å™¨
            document.getElementById('questionCount').textContent = '0';
            document.getElementById('hintCount').textContent = data.hint_count;
            
            // æ¸…ç©ºå†å²è®°å½•
            document.getElementById('history').innerHTML = '';
            addToHistory(`<strong>æ–°æ¸¸æˆå¼€å§‹ï¼</strong><br>åœºæ™¯ï¼š${data.scenario}`, 'scenario');
            
            // å¼€å§‹æ¸¸æˆè®¡æ—¶å™¨
            startGameTimer();
        }

        // æ·»åŠ æ›´æ–°å½“å‰ç©å®¶çš„å‡½æ•°
        function updateCurrentPlayer(currentPlayerName) {
            const isMyTurn = currentPlayerName === playerName;
            
            // æ›´æ–°é—®é¢˜è¾“å…¥æ§ä»¶çŠ¶æ€
            document.getElementById('question').disabled = !isMyTurn;
            document.getElementById('askQuestion').disabled = !isMyTurn;
            
            // æ›´æ–°å½“å‰ç©å®¶æç¤º
            const turnIndicator = document.getElementById('turnIndicator') || createTurnIndicator();
            turnIndicator.textContent = isMyTurn ? 
                'ç°åœ¨æ˜¯ä½ çš„å›åˆï¼Œè¯·æé—®' : 
                `ç°åœ¨æ˜¯ ${currentPlayerName} çš„å›åˆ`;
            turnIndicator.className = `turn-indicator-message ${isMyTurn ? 'my-turn' : ''}`;
        }

        // åˆ›å»ºå›åˆæç¤ºå…ƒç´ 
        function createTurnIndicator() {
            const turnIndicator = document.createElement('div');
            turnIndicator.id = 'turnIndicator';
            turnIndicator.className = 'turn-indicator-message';
            const gameControls = document.getElementById('gameControls');
            gameControls.insertBefore(turnIndicator, gameControls.firstChild);
            return turnIndicator;
        }

        // æ·»åŠ è¯­éŸ³èŠå¤©åŠŸèƒ½
        document.addEventListener('keydown', async (e) => {
            if (e.key.toLowerCase() === 't' && !isVoiceActive) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    isVoiceActive = true;
                    document.getElementById('voiceStatus').classList.remove('d-none');
                    
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
                        sendVoiceMessage(audioBlob);
                    };
                    
                    mediaRecorder.start();
                } catch (error) {
                    console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key.toLowerCase() === 't' && isVoiceActive) {
                isVoiceActive = false;
                document.getElementById('voiceStatus').classList.add('d-none');
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
            }
        });

        // å‘é€è¯­éŸ³æ¶ˆæ¯
        async function sendVoiceMessage(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob);
                formData.append('room_id', currentRoom);
                formData.append('player_name', playerName);
                formData.append('X_API_KEY', apiKey);
                
                const response = await fetch(API.multi.sendVoice, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (!data.status === 'success') {
                    console.error('å‘é€è¯­éŸ³æ¶ˆæ¯å¤±è´¥:', data.message);
                }
            } catch (error) {
                console.error('å‘é€è¯­éŸ³æ¶ˆæ¯å¤±è´¥:', error);
            }
        }

        // æ·»åŠ å‘é€èŠå¤©æ¶ˆæ¯çš„å‡½æ•°
        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            // æ£€æŸ¥æ˜¯å¦è¢«ç¦è¨€
            const player = currentRoom?.players?.find(p => p.name === playerName);
            if (player?.muted_until && player.muted_until > Date.now() / 1000) {
                const remainingTime = Math.ceil((player.muted_until - Date.now() / 1000) / 60);
                alert(`ä½ å·²è¢«ç¦è¨€ï¼Œè¿˜å‰© ${remainingTime} åˆ†é’Ÿ`);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/multi/send_message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom,
                        player_name: playerName,
                        message: message
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    chatInput.value = '';
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            }
        }

        // æ·»åŠ æ›´æ–°èŠå¤©æ¶ˆæ¯çš„å‡½æ•°
        function updateChatMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${msg.sender === playerName ? 'self' : 'other'}`;
                messageDiv.innerHTML = `
                    <div class="sender">${msg.sender}</div>
                    <div class="content">${msg.content}</div>
                    <div class="time">${msg.time}</div>
                `;
                chatMessages.appendChild(messageDiv);
            });
            
            // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ·»åŠ å›è½¦å‘é€æ¶ˆæ¯çš„åŠŸèƒ½
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // ä¿®æ”¹è·å–æˆ¿é—´åˆ—è¡¨çš„å‡½æ•°
        async function getRoomList() {
            try {
                if (!apiKey) {
                    await getApiKey();
                }
                
                const response = await fetch(`${API_BASE_URL}/multi/get_rooms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey
                    })
                });
                
                const data = await response.json();
                console.log('Get rooms response:', data);  // æ·»åŠ è°ƒè¯•æ—¥å¿—
                
                if (data.status === 'success') {
                    updateRoomList(data.rooms);
                } else {
                    console.error('è·å–æˆ¿é—´åˆ—è¡¨å¤±è´¥:', data.message);
                }
            } catch (error) {
                console.error('è·å–æˆ¿é—´åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // ä¿®æ”¹è¯·æ±‚åŠ å…¥æˆ¿é—´çš„å‡½æ•°
        async function requestJoinRoom(roomId) {
            try {
                const playerNameInput = document.getElementById('playerNameInput');
                const name = playerNameInput.value.trim();
                
                if (!name) {
                    alert('è¯·å…ˆè¾“å…¥ä½ çš„åå­—');
                    playerNameInput.focus();
                    return;
                }
                
                showLoading();
                
                const response = await fetch(`${API_BASE_URL}/multi/request_join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: roomId,
                        player_name: name
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    playerName = name; // ä¿å­˜ç©å®¶åç§°
                    currentRoom = roomId; // ä¿å­˜æˆ¿é—´ID
                    
                    // æ›´æ–°ç•Œé¢
                    document.getElementById('roomJoinCreate').style.display = 'none';
                    document.getElementById('roomInfo').style.display = 'block';
                    document.getElementById('roomId').textContent = roomId;
                    
                    // å¼€å§‹è½®è¯¢æˆ¿é—´çŠ¶æ€
                    startPollingRoomStatus();
                    
                    alert('å·²å‘é€åŠ å…¥è¯·æ±‚ï¼Œç­‰å¾…æˆ¿ä¸»å®¡æ ¸');
                } else {
                    throw new Error(data.message || 'è¯·æ±‚åŠ å…¥å¤±è´¥');
                }
            } catch (error) {
                console.error('è¯·æ±‚åŠ å…¥æˆ¿é—´å¤±è´¥:', error);
                alert(error.message || 'è¯·æ±‚åŠ å…¥æˆ¿é—´å¤±è´¥');
            } finally {
                hideLoading();
            }
        }

        // ä¿®æ”¹æ›´æ–°æˆ¿é—´åˆ—è¡¨çš„å‡½æ•°
        function updateRoomList(rooms) {
            const roomList = document.getElementById('roomList');
            roomList.innerHTML = '';
            
            if (rooms.length === 0) {
                roomList.innerHTML = '<div class="text-center p-3">å½“å‰æ²¡æœ‰å¯ç”¨çš„æˆ¿é—´</div>';
                return;
            }
            
            rooms.forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.className = 'room-item';
                roomDiv.innerHTML = `
                    <div class="room-info">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="room-id">æˆ¿é—´ID: ${room.room_id}</span>
                            <span class="player-count">
                                <i class="fas fa-users"></i> ${room.player_count}/8
                            </span>
                        </div>
                        <div class="host-name">æˆ¿ä¸»: ${room.host_name}</div>
                        <div class="room-status ${room.status === 'waiting' ? 'text-success' : 'text-warning'}">
                            <i class="fas fa-circle"></i> 
                            ${room.status === 'waiting' ? 'ç­‰å¾…ä¸­' : 'æ¸¸æˆä¸­'}
                        </div>
                        <div class="room-categories">
                            ${room.story_type ? `<span class="category">ç±»å‹: ${STORY_CATEGORIES.type[room.story_type]}</span>` : ''}
                            ${room.difficulty ? `<span class="category">éš¾åº¦: ${STORY_CATEGORIES.difficulty[room.difficulty]}</span>` : ''}
                            ${room.theme ? `<span class="category">ä¸»é¢˜: ${STORY_CATEGORIES.theme[room.theme]}</span>` : ''}
                        </div>
                    </div>
                    <button class="join-btn" onclick="requestJoinRoom('${room.room_id}')" 
                            ${room.status !== 'waiting' ? 'disabled' : ''}>
                        ${room.status === 'waiting' ? 'åŠ å…¥æˆ¿é—´' : 'æ¸¸æˆä¸­'}
                    </button>
                `;
                roomList.appendChild(roomDiv);
            });
        }

        // ä¿®æ”¹å¤„ç†åŠ å…¥è¯·æ±‚çš„å‡½æ•°
        async function handleJoinRequest(targetPlayerName, accept) {
            try {
                const response = await fetch(`${API_BASE_URL}/multi/handle_join_request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom,
                        host_name: playerName,  // ä½¿ç”¨å½“å‰ç©å®¶åç§°ï¼ˆæˆ¿ä¸»ï¼‰
                        player_name: targetPlayerName,  // ä½¿ç”¨ç›®æ ‡ç©å®¶åç§°
                        accept: accept
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    showSteamDialog('æ“ä½œæˆåŠŸ', data.message, [{
                        text: 'ç¡®å®š',
                        class: 'btn-primary',
                        onClick: () => {}
                    }]);
                } else {
                    throw new Error(data.message || 'å¤„ç†è¯·æ±‚å¤±è´¥');
                }
            } catch (error) {
                console.error('å¤„ç†åŠ å…¥è¯·æ±‚å¤±è´¥:', error);
                showSteamDialog('é”™è¯¯', error.message || 'å¤„ç†åŠ å…¥è¯·æ±‚å¤±è´¥', [{
                    text: 'ç¡®å®š',
                    class: 'btn-danger',
                    onClick: () => {}
                }]);
            }
        }

        // ä¿®æ”¹æ›´æ–°åŠ å…¥è¯·æ±‚åˆ—è¡¨çš„å‡½æ•°
        function updateJoinRequests(requests) {
            const requestsList = document.getElementById('joinRequestsList');
            if (!requestsList) return;
            
            requestsList.innerHTML = '';
            console.log('Updating join requests:', requests);
            
            if (!requests || requests.length === 0) {
                requestsList.innerHTML = '<div class="text-muted">æš‚æ— åŠ å…¥è¯·æ±‚</div>';
                return;
            }
            
            requests.forEach(request => {
                const requestDiv = document.createElement('div');
                requestDiv.className = 'request-item';
                requestDiv.innerHTML = `
                    <span>${request.name} è¯·æ±‚åŠ å…¥</span>
                    <div class="request-buttons">
                        <button class="btn btn-custom btn-sm" onclick="handleJoinRequest('${request.name}', true)">
                            <i class="fas fa-check"></i> æ¥å—
                        </button>
                        <button class="btn btn-custom btn-sm" onclick="handleJoinRequest('${request.name}', false)">
                            <i class="fas fa-times"></i> æ‹’ç»
                        </button>
                    </div>
                `;
                requestsList.appendChild(requestDiv);
            });
        }

        // æ·»åŠ å®šæ—¶åˆ·æ–°æˆ¿é—´åˆ—è¡¨çš„åŠŸèƒ½
        setInterval(() => {
            if (!currentRoom) {  // åªåœ¨æœªåŠ å…¥æˆ¿é—´æ—¶åˆ·æ–°åˆ—è¡¨
                getRoomList();
            }
        }, 5000);

        // å…³é—­ Steam é£æ ¼å¼¹æ¡†
        function closeSteamDialog() {
            document.getElementById('steamDialog').style.display = 'none';
        }

        // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å¼¹æ¡†
        document.addEventListener('DOMContentLoaded', () => {
            addSteamDialog();
        });

        // ä¿®æ”¹ showSteamDialog å‡½æ•°æ”¯æŒè‡ªå®šä¹‰å†…å®¹
        function showSteamDialog(title, message, buttons = [], customContent = '') {
            const dialog = document.getElementById('steamDialog');
            const titleEl = dialog.querySelector('.dialog-title');
            const bodyEl = dialog.querySelector('.dialog-body');
            const buttonsEl = dialog.querySelector('.dialog-buttons');
            
            titleEl.textContent = title;
            
            // æ”¯æŒè‡ªå®šä¹‰å†…å®¹
            if (customContent) {
                bodyEl.innerHTML = message + '<br>' + customContent;
            } else {
                bodyEl.textContent = message;
            }
            
            // æ¸…é™¤ä¹‹å‰çš„æŒ‰é’®
            buttonsEl.innerHTML = '';
            
            // æ·»åŠ æ–°æŒ‰é’®
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `btn btn-custom ${btn.class || ''}`;
                button.textContent = btn.text;
                button.onclick = () => {
                    btn.onClick();
                    if (btn.keepOpen !== true) {
                        closeSteamDialog();
                    }
                };
                buttonsEl.appendChild(button);
            });
            
            dialog.style.display = 'flex';
            
            // å¦‚æœæœ‰è¾“å…¥æ¡†ï¼Œè‡ªåŠ¨èšç„¦
            const input = dialog.querySelector('input');
            if (input) {
                input.focus();
                // æ·»åŠ å›è½¦é”®æ”¯æŒ
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        const confirmBtn = buttonsEl.querySelector('.btn-primary');
                        if (confirmBtn) {
                            confirmBtn.click();
                        }
                    }
                };
            }
        }

        // æ·»åŠ åˆå§‹åŒ–å¼¹æ¡†çš„å‡½æ•°
        function addSteamDialog() {
            const dialogHTML = `
                <div id="steamDialog" class="steam-dialog" style="display: none;">
                    <div class="steam-dialog-content">
                        <div class="steam-dialog-header">
                            <h4 class="dialog-title"></h4>
                            <button class="close-btn" onclick="closeSteamDialog()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="dialog-body"></div>
                        <div class="dialog-buttons"></div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
        }

        // ... ç°æœ‰ä»£ç  ...

        // ä¿®æ”¹åˆå§‹åŒ–æç¤ºçš„æ˜¾ç¤ºé€»è¾‘
        function showInitDialog() {
            showSteamDialog('æ¬¢è¿', 'æ¬¢è¿æ¥åˆ°æµ·é¾Ÿæ±¤æ¨ç†æ¸¸æˆï¼', [
                {
                    text: 'å¼€å§‹æ¸¸æˆ',
                    class: 'btn-primary',
                    onClick: () => {
                        // è®¾ç½®å·²åˆå§‹åŒ–æ ‡è®°
                        localStorage.setItem('initialized', 'true');
                        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–åˆå§‹åŒ–é€»è¾‘
                    }
                }
            ]);
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºåˆå§‹åŒ–æç¤º
        if (!localStorage.getItem('initialized')) {
            showInitDialog();
        }

        // ... å…¶ä½™ä»£ç  ...
    </script>
</body>
</html>